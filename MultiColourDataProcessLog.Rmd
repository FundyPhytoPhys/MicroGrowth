---
title: "MultiDataProcess"
author:
- Laurel Genge
- Carlie Barnhill
- Max Berthold
- Douglas A. Campbell
date: "`r format(Sys.Date())`"
output:
  html_document:
    code_folding: hide
    toc: TRUE
    toc_float: TRUE
---

# Run These Chunks First
```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
knitr::opts_chunk$set(fig.path='Figs/')
```

# Introduction
Implement logistic growth curve fits to MultiCulti growth trajectories imported and tidied using MultiColourDataImport.Rmd

# Load Libraries and set project variables

Run only first time in session

```{r load libraries}
# libraries; Note check actual dependencies
library(tidyverse)
library(lubridate)
library(stringr)
library(broom)
library(knitr)
library(zoo)
#library(tidyquant)
#library(data.table)
#library(googledrive)
#library(googlesheets4)
library(minpack.lm)
#library(dplyr)

#attach psych for harmonic.mean() for averaging rates
#library(psych)
```

Run only first time in session

```{r set project variables}
#"..", takes up a level in the directory path
Project <- "PICO"
ImportedData <- file.path("ImportedColourData")
PlotsPath <- file.path("Figs")
ProcessedData <- file.path("ProcessedData", "ColourLogGrowthFits")

Sensor <- "od-680"


#set the hour of day at which photoperiod starts for later generation of ToD Time of Day
StartHour <- 6

```

Run only first time in session

```{r set colours}
MyWavelengths = c(405, 450, 475, 530, 615, 660, 730, "WW")
MCMIXColours = c("violet", "darkblue", "dodgerblue", "green","orange","red","purple", "black")

names(MCMIXColours) <- MyWavelengths
MCMIXColours
```



# List previously processed files

Run only first time in session

```{r previously processed files}
list.files(path = ProcessedData, pattern = Project, full.names = TRUE)

```

# List available tidied, organized .Rds files of MultiCulti data.

Exported from runs of MultiColourImport.Rmd Run only first time in session

```{r list tidied data files}
list.files(path = ImportedData, pattern = Project, full.names = TRUE)

```

# Select and Read ProcessFile

Run for each file in a session; all chunks below run for each file.

```{r read ProcessFile}
ProcessFile <- "ImportedColourData/20200124_PICO_MCMIX004_RUN1_TargetDataMetaFilter.Rds"

ProcessFileName <- str_split(string = ProcessFile, "/")[[1]][2] %>%
  str_remove(pattern = ".Rds") %>%
  str_remove(pattern = "_TargetDataMetaFilter")

ProcessData <- readRDS(ProcessFile)  %>%
  ungroup()

colnames(ProcessData)
```

Remove extraneous columns from ProcessData; could have done at end of MultiDataImport.Rmd
```{r clean up ProcessData}
ProcessData <- ProcessData %>%
  select(-contains("actinic-lights.light")) %>%
  select(-c("Plate", "Well", "MovAvg", "IsMovAvgOutlier"))

colnames(ProcessData)

```

Add ln and deltaOD columns; filter for failed ln
```{r add ln and deltaOD columns}
ProcessData <- ProcessData %>%
  mutate(#lnOD720 = log(OD720),
         #lnOD680 = log(OD680),
         deltaOD = OD680 - OD720) %>%
         #lndeltaOD = log(deltaOD)) %>%
  #drop_na(lndeltaOD)  %>%
  drop_na(Tube, MC, ExpDate) 
  #filter(!is.infinite(lnOD720)) %>%
  #filter(!is.infinite(lnOD680)) %>%
  #filter(!is.infinite(lndeltaOD)) %>%
  #filter(!is.nan(lnOD720)) %>%
  #filter(!is.nan(lnOD680)) %>%
  #filter(!is.nan(lndeltaOD))

```


# Generate a plot of the data in the selected tidied MultiCulti file.

```{r prelim ProcessPlot}
#Run <- c("MultiCulti/20200124_PICO_MCMIX004_RUN1.csv", "MultiCulti/20200124_PICO_MCMIX006_RUN2.csv")

ProcessData %>%
  ggplot() +
  geom_point(aes(x = time, y = OD720), size = 0.1) +
  geom_point(aes(x = time, y = actinic_par/1000, colour = as.factor(WL)), size = 0.05) +
  scale_colour_manual(values = MCMIXColours) +
  facet_grid(rows = vars(O2), cols = vars(as.factor(Tube), Strain, Par_ue)) +
  theme_bw()

ProcessData %>%
  ggplot() +
  geom_point(aes(x = time, y = log(OD720)), size = 0.1) +
  geom_point(aes(x = time, y = actinic_par/100, colour = as.factor(WL)), size = 0.05) +
  scale_colour_manual(values = MCMIXColours) +
  facet_grid(rows = vars(O2), cols = vars(as.factor(Tube), Strain, Par_ue)) +
  theme_bw()

```

# For split files only; select the interval that covers before the change in actinic light
```{r Interval Data for split files}
#even multiples of 24 + StartHour to start at photoperiod
#LowerTime <- 24 * 1
UpperTime <- 24 * 8

ProcessData <- ProcessData %>%
  filter(time <= UpperTime)
```


# Attempt Logistic Fits of Data
Create R function for logistic equation.
```{r logistic function, message = FALSE}
#define a logistic equation as a function.
#x will be taken from 'time' when we run the fit.
logistic_eqn <- function(x, pmax, mu, intercept){(pmax*intercept*exp(mu*x))/(pmax + (intercept*(exp(mu*x)-1)))
}
```

Set starting values for logistic model
Replace this with Max's self-starting routines
```{r set starting values for logistic model, message = FALSE}
#define starting, lower, and upper bounds for fit parameters to constrain logistic fit
# logistic_eqn_start<-list(pmax = max(ProcessData$Areamm2, na.rm = TRUE), mu = 0.05, intercept = min(MyData$Areamm2, na.rm = TRUE))
# 
# logistic_eqn_lower<-c((max(MyData$Areamm2, na.rm = TRUE) * 0.5),0.001,((min(MyData$Areamm2, na.rm = TRUE) * 0.1)))
# 
# logistic_eqn_upper<-c((max(MyData$Areamm2, na.rm = TRUE) * 2),1,((min(MyData$Areamm2, na.rm = TRUE) * 4)))

logistic_eqn_start <- list(pmax = 0.3, mu = 0.01, intercept = 0.01)
logistic_eqn_lower <- c(0.1, -0.1, 0.001)
logistic_eqn_upper <- c(0.5, 0.1, 0.1)
```

Logistic fits across entire data sets; not appropriate for split condition runs
Re-write with self-seeding functions to avoid starting values?
```{r nested logistic regressions }
ProcessDataNestGrowth  <- ProcessData %>% 
   nest(data = c(time, abs_time, ToD, actinic_par, OD680, OD720, deltaOD)) %>%
  mutate(
  OD720_logistic = map(data, possibly(~nlsLM(OD720 ~ logistic_eqn(x = time, pmax, mu, intercept), data = .x, start = logistic_eqn_start, lower = logistic_eqn_lower, upper = logistic_eqn_upper), otherwise = NULL)),
  #OD720_logistic_predict = map(OD720_logistic, possibly(augment, otherwise = NULL)),
  OD720_logistic_tidied =  map(OD720_logistic, possibly(tidy, otherwise = NULL)),
 OD720_logistic_param = map(OD720_logistic,possibly(glance, otherwise = NULL)),
 deltaOD_logistic = map(data, possibly(~nlsLM(deltaOD ~ logistic_eqn(x = time, pmax, mu, intercept), data = .x, start = logistic_eqn_start, lower = logistic_eqn_lower, upper = logistic_eqn_upper), otherwise = NULL)),
  #deltaOD_logistic_predict = map(OD720_logistic, possibly(augment, otherwise = NULL)),
  deltaOD_logistic_tidied =  map(deltaOD_logistic, possibly(tidy, otherwise = NULL)),
 deltaOD_logistic_param = map(deltaOD_logistic,possibly(glance, otherwise = NULL))
  )
```

```{r plot logistics predictions}
#improve with automated annotate placement based upon data traces; difficulty is that data is nested until expansion for ggplot b/c we need to conserve memory so data traces are not easily accessible
# segmentYstart <- as.numeric(IntervalDataTube1[IntervalDataTube1$time == 52, "lnOD680"])
# segmentYend <- as.numeric(IntervalDataTube1[IntervalDataTube1$time == 54, "lnOD680"])

#Replace annotation settings with values derived from data
OD_x = 170
OD_y = 0.08

Par_x = 190
Par_y = 0.04

Resid_x = 30
Resid_y = -0.01

Predict_x = 55
Predict_y = 0.04

#predictions of condition specific fits
OD720LogGrowthPlot <- ProcessDataNestGrowth %>%
  #filter(Tube == 1) %>%
  mutate(OD720_logistic_predict = map(OD720_logistic, possibly(augment, otherwise = NULL))) %>%
  unnest(cols = c(data, OD720_logistic_predict),names_sep = "_") %>%
  ggplot() +
  geom_point(aes(x = data_time, y = data_OD720), colour = "darkgreen", size = 0.1) +
  scale_colour_manual(values = MCMIXColours) +
  geom_point(aes(x = data_time, y = OD720_logistic_predict_.fitted), colour = "black", size = 0.1) +
  geom_point(aes(x = data_time, y = OD720_logistic_predict_.resid), colour = "red", size = 0.05) +geom_point(aes(x = data_time, y = data_actinic_par/1000, colour = as.factor(WL)), size = 0.05, alpha = 0.1) +
  coord_cartesian(xlim = c(-5, 260)) +
  scale_x_continuous(breaks=seq(0, 250, by = 125)) +
  facet_grid(rows = vars(O2), cols = vars(Tube, WL, Par_ue, Strain)) +
  labs(subtitle = "Tube; Growth Light (nm; µE); Strain", caption = ProcessFileName, y = "Optical Density 720nm (OD720)", x = "Elapsed Time (h)") +
  theme_bw() +
  labs(colour = "Actinic PAR (nm)")

OD720LogGrowthPlot



OD720LogGrowthPlotExpand <- ProcessDataNestGrowth %>%
  filter(Tube == 1) %>%
  mutate(OD720_logistic_predict = map(OD720_logistic, possibly(augment, otherwise = NULL))) %>%
  unnest(cols = c(data, OD720_logistic_predict),names_sep = "_") %>%
  ggplot() +
  geom_point(aes(x = data_time, y = data_OD720), colour = "darkgreen", size = 0.1) +
  scale_colour_manual(values = MCMIXColours) +
  geom_point(aes(x = data_time, y = OD720_logistic_predict_.fitted), colour = "black", size = 0.1) +
  geom_point(aes(x = data_time, y = OD720_logistic_predict_.resid), colour = "red", size = 0.05) + 
  geom_point(aes(x = data_time, y = data_actinic_par/1000, colour = as.factor(WL)), size = 0.1, alpha = 0.1) +
  coord_cartesian(xlim = c(-5, 260)) +
  scale_x_continuous(breaks=seq(0, 250, by = 125)) +
  facet_grid(rows = vars(O2), cols = vars(Tube, WL, Par_ue, Strain)) +
  annotate(geom = "text", x = OD_x, y = OD_y, label = "deltaOD", size = 5, colour = "darkgreen") +
  annotate(geom = "text", x = Par_x, y = Par_y, label = "Light level", size = 5, colour = "darkblue") +
  annotate(geom = "text", x = Resid_x, y = Resid_y, label = "Model residuals", size = 5, colour = "red") +
  annotate(geom = "text", x = Predict_x, y = Predict_y, label = "Logistic Regression", size = 5, colour = "black") +
  #7_cartesian(xlim = c(-5, 255)) +
  labs(subtitle = "Tube; Growth Light (nm; µE); Strain", caption = ProcessFileName, y = "Optical Density 720nm (OD720)", x = "Elapsed Time (h)") +
  theme_bw() +
  labs(colour = "Actinic PAR (nm)")

OD720LogGrowthPlotExpand

DeltaODLogGrowthPlot <- ProcessDataNestGrowth %>%
  #filter(Tube == 1) %>%
  mutate(deltaOD_logistic_predict = map(deltaOD_logistic, possibly(augment, otherwise = NULL))) %>%
  unnest(cols = c(data, deltaOD_logistic_predict),names_sep = "_") %>%
  ggplot() +
  geom_point(aes(x = data_time, y = data_deltaOD), colour = "darkgreen", size = 0.1) +
  scale_colour_manual(values = MCMIXColours) +
  geom_point(aes(x = data_time, y = deltaOD_logistic_predict_.fitted), colour = "black", size = 0.1) +
  geom_point(aes(x = data_time, y = deltaOD_logistic_predict_.resid), colour = "red", size = 0.05) +geom_point(aes(x = data_time, y = data_actinic_par/1000, colour = as.factor(WL)), size = 0.05, alpha = 0.1) +
  coord_cartesian(xlim = c(-5, 260)) +
  scale_x_continuous(breaks=seq(0, 250, by = 125)) +
  facet_grid(rows = vars(O2), cols = vars(Tube, WL, Par_ue, Strain)) +
  labs(subtitle = "Tube; Growth Light (nm; µE); Strain", caption = ProcessFileName, y = "Delta Optical Density (deltaOD)", x = "Elapsed Time (h)") +
  theme_bw() +
  labs(colour = "Actinic PAR (nm)")

DeltaODLogGrowthPlot

DeltaODLogGrowthPlotExpand <- ProcessDataNestGrowth %>%
  filter(Tube == 1) %>%
  mutate(deltaOD_logistic_predict = map(deltaOD_logistic, possibly(augment, otherwise = NULL))) %>%
  unnest(cols = c(data, deltaOD_logistic_predict),names_sep = "_") %>%
  ggplot() +
  geom_point(aes(x = data_time, y = data_deltaOD), colour = "darkgreen", size = 0.1) +
  scale_colour_manual(values = MCMIXColours) +
  geom_point(aes(x = data_time, y = deltaOD_logistic_predict_.fitted), colour = "black", size = 0.1) +
  geom_point(aes(x = data_time, y = deltaOD_logistic_predict_.resid), colour = "red", size = 0.05) + 
  geom_point(aes(x = data_time, y = data_actinic_par/1000, colour = as.factor(WL)), size = 0.5, alpha = 0.1) +
  coord_cartesian(xlim = c(0, 250)) +
  scale_x_continuous(breaks=seq(0, 250, by = 125)) +
  facet_grid(rows = vars(O2), cols = vars(Tube, WL, Par_ue, Strain)) +
  annotate(geom = "text", x = OD_x, y = OD_y, label = "deltaOD", size = 5, colour = "darkgreen") +
  annotate(geom = "text", x = Par_x, y = Par_y, label = "Light level", size = 5, colour = "darkblue") +
  annotate(geom = "text", x = Resid_x, y = Resid_y, label = "Model residuals", size = 5, colour = "red") +
  annotate(geom = "text", x = Predict_x, y = Predict_y, label = "Logistic Regression", size = 5, colour = "black") +
  labs(subtitle = "Tube; Growth Light (nm; µE); Strain", caption = ProcessFileName , y = "Delta Optical Density (deltaOD)", x = "Elapsed Time (h)") +
  theme_bw() +
  labs(colour = "Actinic PAR (nm)")

DeltaODLogGrowthPlotExpand

```

```{r save logistic model plots}
# ggsave(file = file.path(PlotsPath, paste(ProcessFileName, "OD720LogGrowthPlot",".png",sep = "")), plot = OD720LogGrowthPlot, device = NULL, scale = 1, height=10, width= 20, units = c("cm"),dpi = 300, limitsize = TRUE)
# 
# ggsave(file = file.path(PlotsPath, paste(ProcessFileName, "OD720LogGrowthPlotExpand",".png",sep = "")), plot = OD720LogGrowthPlotExpand, device = NULL, scale = 1, height=10, width= 20, units = c("cm"),dpi = 300, limitsize = TRUE)
# 
# ggsave(file = file.path(PlotsPath, paste(ProcessFileName, "DeltaODLogGrowthPlot",".png",sep = "")), plot = DeltaODLogGrowthPlot, device = NULL, scale = 1, height=10, width= 20, units = c("cm"),dpi = 300, limitsize = TRUE)
# 
# ggsave(file = file.path(PlotsPath, paste(ProcessFileName, "DeltaODLogGrowthPlotExpand",".png",sep = "")), plot = DeltaODLogGrowthPlotExpand, device = NULL, scale = 1, height=10, width= 20, units = c("cm"),dpi = 300, limitsize = TRUE)

```

```{r logistic fit terms}
kable(ProcessDataNestGrowth %>%
 unnest(cols = c(OD720_logistic_tidied),names_sep = "_") %>%
  select(c(Filename, Tube, Strain, Par_ue, Photoperiod, Temp_c, O2, WL, LightShape, OD720_logistic_tidied_term, OD720_logistic_tidied_estimate, OD720_logistic_tidied_std.error)) %>%
  pivot_wider(names_from =  OD720_logistic_tidied_term, values_from = c(OD720_logistic_tidied_estimate, OD720_logistic_tidied_std.error), names_sep = "_")  %>%
  rename(OD720_pmax = OD720_logistic_tidied_estimate_pmax,
         OD720_pmax_se = OD720_logistic_tidied_std.error_pmax,
         OD720_mu= OD720_logistic_tidied_estimate_mu,
         OD720_mu_se = OD720_logistic_tidied_std.error_mu,
         OD720_intercept = OD720_logistic_tidied_estimate_intercept,
         OD720_intercept_se = OD720_logistic_tidied_std.error_intercept))

 #%>%
  #mutate(GrowthFlag = if_else((OD720_intercept + OD720_intercept_se) < (OD720_pmax - OD720_pmax_se), 1, 0)))



```

Plot Logistic Fit Terms vs. conditions
```{r logistic fit terms}
ProcessDataNestGrowth %>%
 unnest(cols = c(OD720_logistic_tidied),names_sep = "_") %>%
  select(c(Filename, Tube, Strain, Par_ue, Photoperiod, Temp_c, O2, WL, LightShape, OD720_logistic_tidied_term, OD720_logistic_tidied_estimate, OD720_logistic_tidied_std.error)) %>%
  pivot_wider(names_from =  OD720_logistic_tidied_term, values_from = c(OD720_logistic_tidied_estimate, OD720_logistic_tidied_std.error), names_sep = "_") %>%
  rename(OD720_pmax = OD720_logistic_tidied_estimate_pmax,
         OD720_pmax_se = OD720_logistic_tidied_std.error_pmax,
         OD720_mu = OD720_logistic_tidied_estimate_mu,
         OD720_mu_se = OD720_logistic_tidied_std.error_mu,
         OD720_intercept = OD720_logistic_tidied_estimate_intercept,
         OD720_intercept_se = OD720_logistic_tidied_std.error_intercept) %>%
  mutate(GrowthFlag = if_else((OD720_intercept + OD720_intercept_se)  < (OD720_pmax - OD720_pmax_se), 1, 0)) %>%
  ggplot() +
  geom_point(aes(x = Par_ue, y = OD720_mu, colour = as.factor(WL))) +
  geom_errorbar(aes(x = Par_ue, ymin = OD720_mu - OD720_mu_se, ymax = OD720_mu + OD720_mu_se, colour = as.factor(WL))) + 
  scale_colour_manual(values = MCMIXColours) +
  facet_grid (cols = vars(Strain), rows = vars(O2)) +
  theme_bw()

ProcessDataNestGrowth %>%
 unnest(cols = c(deltaOD_logistic_tidied),names_sep = "_") %>%
  select(c(Filename, Tube, Strain, Par_ue, Photoperiod, Temp_c, O2, WL, LightShape, deltaOD_logistic_tidied_term, deltaOD_logistic_tidied_estimate, deltaOD_logistic_tidied_std.error)) %>%
  pivot_wider(names_from =  deltaOD_logistic_tidied_term, values_from = c(deltaOD_logistic_tidied_estimate, deltaOD_logistic_tidied_std.error), names_sep = "_") %>%
  rename(deltaOD_pmax = deltaOD_logistic_tidied_estimate_pmax,
         deltaOD_pmax_se = deltaOD_logistic_tidied_std.error_pmax,
         deltaOD_mu = deltaOD_logistic_tidied_estimate_mu,
         deltaOD_mu_se = deltaOD_logistic_tidied_std.error_mu,
         deltaOD_intercept = deltaOD_logistic_tidied_estimate_intercept,
         deltaOD_intercept_se = deltaOD_logistic_tidied_std.error_intercept) %>%
  mutate(GrowthFlag = if_else((deltaOD_intercept + deltaOD_intercept_se)  < (deltaOD_pmax - deltaOD_pmax_se), 1, 0)) %>%
  ggplot() +
  geom_point(aes(x = Par_ue, y = deltaOD_mu, colour = as.factor(WL))) +
  geom_errorbar(aes(x = Par_ue, ymin = deltaOD_mu - deltaOD_mu_se, ymax = deltaOD_mu + deltaOD_mu_se, colour = as.factor(WL))) + 
  scale_colour_manual(values = MCMIXColours) +
  facet_grid (cols = vars(Strain), rows = vars(O2)) +
  theme_bw()

ProcessDataNestGrowth %>%
 unnest(cols = c(OD720_logistic_tidied),names_sep = "_") %>%
  select(c(Filename, Tube, Strain, Par_ue, Photoperiod, Temp_c, O2, WL, LightShape, OD720_logistic_tidied_term, OD720_logistic_tidied_estimate, OD720_logistic_tidied_std.error)) %>%
  pivot_wider(names_from =  OD720_logistic_tidied_term, values_from = c(OD720_logistic_tidied_estimate, OD720_logistic_tidied_std.error), names_sep = "_") %>%
  rename(OD720_pmax = OD720_logistic_tidied_estimate_pmax,
         OD720_pmax_se = OD720_logistic_tidied_std.error_pmax,
         OD720_mu = OD720_logistic_tidied_estimate_mu,
         OD720_mu_se = OD720_logistic_tidied_std.error_mu,
         OD720_intercept = OD720_logistic_tidied_estimate_intercept,
         OD720_intercept_se = OD720_logistic_tidied_std.error_intercept) %>%
  mutate(GrowthFlag = if_else((OD720_intercept + OD720_intercept_se)  < (OD720_pmax - OD720_pmax_se), 1, 0)) %>%
  ggplot() +
  geom_point(aes(x = Par_ue, y = OD720_pmax, colour = as.factor(WL))) +
  geom_errorbar(aes(x = Par_ue, ymin = OD720_pmax - OD720_pmax_se, ymax = OD720_pmax + OD720_pmax_se, colour = as.factor(WL))) + 
  scale_colour_manual(values = MCMIXColours) +
  facet_grid (cols = vars(Strain), rows = vars(O2)) +
  theme_bw()

ProcessDataNestGrowth %>%
 unnest(cols = c(deltaOD_logistic_tidied),names_sep = "_") %>%
  select(c(Filename, Tube, Strain, Par_ue, Photoperiod, Temp_c, O2, WL, LightShape, deltaOD_logistic_tidied_term, deltaOD_logistic_tidied_estimate, deltaOD_logistic_tidied_std.error)) %>%
  pivot_wider(names_from =  deltaOD_logistic_tidied_term, values_from = c(deltaOD_logistic_tidied_estimate, deltaOD_logistic_tidied_std.error), names_sep = "_") %>%
  rename(deltaOD_pmax = deltaOD_logistic_tidied_estimate_pmax,
         deltaOD_pmax_se = deltaOD_logistic_tidied_std.error_pmax,
         deltaOD_mu = deltaOD_logistic_tidied_estimate_mu,
         deltaOD_mu_se = deltaOD_logistic_tidied_std.error_mu,
         deltaOD_intercept = deltaOD_logistic_tidied_estimate_intercept,
         deltaOD_intercept_se = deltaOD_logistic_tidied_std.error_intercept) %>%
  mutate(GrowthFlag = if_else((deltaOD_intercept + deltaOD_intercept_se)  < (deltaOD_pmax - deltaOD_pmax_se), 1, 0)) %>%
  ggplot() +
  geom_point(aes(x = Par_ue, y = deltaOD_pmax, colour = as.factor(WL))) +
  geom_errorbar(aes(x = Par_ue, ymin = deltaOD_pmax - deltaOD_pmax_se, ymax = deltaOD_pmax + deltaOD_pmax_se, colour = as.factor(WL))) + 
  scale_colour_manual(values = MCMIXColours) +
  facet_grid (cols = vars(Strain), rows = vars(O2)) +
  theme_bw()

```


Plotting Growth Summary 
plots logistic fit terms vs conditions 
```{r growth summary plots}

ProcessDataNestGrowth %>%
 unnest(cols = c(OD720_logistic_tidied),names_sep = "_") %>%
  select(c(Filename, Tube, Strain, Par_ue, Photoperiod, Temp_c, O2, WL, LightShape, OD720_logistic_tidied_term, OD720_logistic_tidied_estimate, OD720_logistic_tidied_std.error)) %>%
  pivot_wider(names_from =  OD720_logistic_tidied_term, values_from = c(OD720_logistic_tidied_estimate, OD720_logistic_tidied_std.error), names_sep = "_") %>%
  rename(OD720_pmax = OD720_logistic_tidied_estimate_pmax,
         OD720_pmax_se = OD720_logistic_tidied_std.error_pmax,
         OD720_mu = OD720_logistic_tidied_estimate_mu,
         OD720_mu_se = OD720_logistic_tidied_std.error_mu,
         OD720_intercept = OD720_logistic_tidied_estimate_intercept,
         OD720_intercept_se = OD720_logistic_tidied_std.error_intercept) %>%
  mutate(GrowthFlag = if_else((OD720_intercept + OD720_intercept_se)  < (OD720_pmax - OD720_pmax_se), 1, 0)) %>%
  ggplot() +
  geom_point(aes(x = Par_ue, y = OD720_mu, colour = as.factor(WL))) +
  geom_errorbar(aes(x = Par_ue, ymin = OD720_mu - OD720_mu_se, ymax = OD720_mu + OD720_mu_se, colour = as.factor(WL))) + 
  scale_colour_manual(values = MCMIXColours) +
  facet_grid (cols = vars(Strain), rows = vars(O2)) +
  theme_bw()

ProcessDataNestGrowth %>%
 unnest(cols = c(deltaOD_logistic_tidied),names_sep = "_") %>%
  select(c(Filename, Tube, Strain, Par_ue, Photoperiod, Temp_c, O2, WL, LightShape, deltaOD_logistic_tidied_term, deltaOD_logistic_tidied_estimate, deltaOD_logistic_tidied_std.error)) %>%
  pivot_wider(names_from =  deltaOD_logistic_tidied_term, values_from = c(deltaOD_logistic_tidied_estimate, deltaOD_logistic_tidied_std.error), names_sep = "_") %>%
  rename(deltaOD_pmax = deltaOD_logistic_tidied_estimate_pmax,
         deltaOD_pmax_se = deltaOD_logistic_tidied_std.error_pmax,
         deltaOD_mu = deltaOD_logistic_tidied_estimate_mu,
         deltaOD_mu_se = deltaOD_logistic_tidied_std.error_mu,
         deltaOD_intercept = deltaOD_logistic_tidied_estimate_intercept,
         deltaOD_intercept_se = deltaOD_logistic_tidied_std.error_intercept) %>%
  mutate(GrowthFlag = if_else((deltaOD_intercept + deltaOD_intercept_se)  < (deltaOD_pmax - deltaOD_pmax_se), 1, 0)) %>%
  ggplot() +
  geom_point(aes(x = Par_ue, y = deltaOD_mu, colour = as.factor(WL))) +
  geom_errorbar(aes(x = Par_ue, ymin = deltaOD_mu - deltaOD_mu_se, ymax = deltaOD_mu + deltaOD_mu_se, colour = as.factor(WL))) + 
  scale_colour_manual(values = MCMIXColours) +
  facet_grid (cols = vars(Strain), rows = vars(O2)) +
  theme_bw()

ProcessDataNestGrowth %>%
 unnest(cols = c(OD720_logistic_tidied),names_sep = "_") %>%
  select(c(Filename, Tube, Strain, Par_ue, Photoperiod, Temp_c, O2, WL, LightShape, OD720_logistic_tidied_term, OD720_logistic_tidied_estimate, OD720_logistic_tidied_std.error)) %>%
  pivot_wider(names_from =  OD720_logistic_tidied_term, values_from = c(OD720_logistic_tidied_estimate, OD720_logistic_tidied_std.error), names_sep = "_") %>%
  rename(OD720_pmax = OD720_logistic_tidied_estimate_pmax,
         OD720_pmax_se = OD720_logistic_tidied_std.error_pmax,
         OD720_mu = OD720_logistic_tidied_estimate_mu,
         OD720_mu_se = OD720_logistic_tidied_std.error_mu,
         OD720_intercept = OD720_logistic_tidied_estimate_intercept,
         OD720_intercept_se = OD720_logistic_tidied_std.error_intercept) %>%
  mutate(GrowthFlag = if_else((OD720_intercept + OD720_intercept_se)  < (OD720_pmax - OD720_pmax_se), 1, 0)) %>%
  ggplot() +
  geom_point(aes(x = Par_ue, y = OD720_pmax, colour = as.factor(WL))) +
  geom_errorbar(aes(x = Par_ue, ymin = OD720_pmax - OD720_pmax_se, ymax = OD720_pmax + OD720_pmax_se, colour = as.factor(WL))) + 
  scale_colour_manual(values = MCMIXColours) +
  facet_grid (cols = vars(Strain), rows = vars(O2)) +
  theme_bw()

ProcessDataNestGrowth %>%
 unnest(cols = c(deltaOD_logistic_tidied),names_sep = "_") %>%
  select(c(Filename, Tube, Strain, Par_ue, Photoperiod, Temp_c, O2, WL, LightShape, deltaOD_logistic_tidied_term, deltaOD_logistic_tidied_estimate, deltaOD_logistic_tidied_std.error)) %>%
  pivot_wider(names_from =  deltaOD_logistic_tidied_term, values_from = c(deltaOD_logistic_tidied_estimate, deltaOD_logistic_tidied_std.error), names_sep = "_") %>%
  rename(deltaOD_pmax = deltaOD_logistic_tidied_estimate_pmax,
         deltaOD_pmax_se = deltaOD_logistic_tidied_std.error_pmax,
         deltaOD_mu = deltaOD_logistic_tidied_estimate_mu,
         deltaOD_mu_se = deltaOD_logistic_tidied_std.error_mu,
         deltaOD_intercept = deltaOD_logistic_tidied_estimate_intercept,
         deltaOD_intercept_se = deltaOD_logistic_tidied_std.error_intercept) %>%
  mutate(GrowthFlag = if_else((deltaOD_intercept + deltaOD_intercept_se)  < (deltaOD_pmax - deltaOD_pmax_se), 1, 0)) %>%
  ggplot() +
  geom_point(aes(x = Par_ue, y = deltaOD_pmax, colour = as.factor(WL))) +
  geom_errorbar(aes(x = Par_ue, ymin = deltaOD_pmax - deltaOD_pmax_se, ymax = deltaOD_pmax + deltaOD_pmax_se, colour = as.factor(WL))) + 
  scale_colour_manual(values = MCMIXColours) +
  facet_grid (cols = vars(Strain), rows = vars(O2)) +
  theme_bw()

```



# Save .Rds of ProcessDataNestGrowth containing logistic fits of growth data from time resolved and whole interval fits

```{r}
saveRDS(object = ProcessDataNestGrowth, file = file.path(ProcessedData, paste(ProcessFileName,  "ProcessDataNestGrowth.Rds",  sep = "_")), ascii = FALSE, version = NULL, compress = TRUE, refhook = NULL)
```
